syntax = "proto3";

package example;

option go_package = "github.com/drewfead/proto-cli/simple";

import "internal/clipb/cli.proto";

// DatabaseConfig is a nested configuration message
message DatabaseConfig {
  string url = 1 [(cli.flag) = {
    name: "url",
    usage: "Database connection URL"
  }];
  int32 max_connections = 2 [(cli.flag) = {
    name: "max-connections",
    usage: "Maximum database connections"
  }];
  int32 timeout_seconds = 3 [(cli.flag) = {
    name: "timeout",
    usage: "Connection timeout in seconds"
  }];
}

// LogLevel enum for configuration
enum LogLevel {
  LOG_LEVEL_UNSPECIFIED = 0;
  DEBUG = 1;
  INFO = 2;
  WARN = 3;
  ERROR = 4;
}

// PostgresBackend configuration
message PostgresBackend {
  string host = 1;
  int32 port = 2;
  string database = 3;
}

// MySQLBackend configuration
message MySQLBackend {
  string host = 1;
  int32 port = 2;
  string database = 3;
  bool enable_ssl = 4;
}

// UserServiceConfig defines configuration for UserService
message UserServiceConfig {
  string database_url = 1 [(cli.flag) = {
    name: "db-url",
    usage: "PostgreSQL connection URL",
    required: true
  }];
  int64 max_connections = 2 [(cli.flag) = {
    name: "max-conns",
    usage: "Maximum database connections"
  }];

  // Nested message field
  DatabaseConfig database = 3 [(cli.flag) = {
    name: "database",
    usage: "Database configuration"
  }];

  // Enum field
  LogLevel log_level = 4 [(cli.flag) = {
    name: "log-level",
    usage: "Logging level"
  }];

  // Repeated field
  repeated string allowed_origins = 5 [(cli.flag) = {
    name: "allowed-origins",
    usage: "CORS allowed origins"
  }];

  // Map field
  map<string, string> feature_flags = 6;

  // Oneof (union type)
  oneof backend {
    PostgresBackend postgres = 7;
    MySQLBackend mysql = 8;
  }
}

// Address is a nested message type for demonstrating recursive deserializers
message Address {
  string street = 1;
  string city = 2;
  string state = 3;
  string zip_code = 4;
  string country = 5;
}

// User message definition
message User {
  int64 id = 1;
  string name = 2;
  string email = 3;
  int64 created_at = 4;
  Address address = 5;  // Nested address field
}

// Request to get a user by ID
message GetUserRequest {
  int64 id = 1 [(cli.flag) = {
    name: "id",
    shorthand: "i",
    usage: "User ID to retrieve",
    required: true
  }];
}

// Request to create a new user
message CreateUserRequest {
  string name = 1 [(cli.flag) = {
    name: "name",
    shorthand: "n",
    usage: "User's full name",
    required: true
  }];
  string email = 2 [(cli.flag) = {
    name: "email",
    shorthand: "e",
    usage: "User's email address",
    required: true
  }];
  Address address = 3;  // Nested address - demonstrates recursive deserializers
}

// Response containing a user
message UserResponse {
  User user = 1;
  string message = 2;
}

// UserService defines gRPC service methods
service UserService {
  option (cli.service_config) = {
    config_message: "UserServiceConfig"
  };

  // GetUser retrieves a user by ID
  rpc GetUser(GetUserRequest) returns (UserResponse) {
    option (cli.command) = {
      command: ["user", "get"],
      description: "Retrieve a user by ID"
    };
  }

  // CreateUser creates a new user
  rpc CreateUser(CreateUserRequest) returns (UserResponse) {
    option (cli.command) = {
      command: ["user", "create"],
      description: "Create a new user"
    };
  }

  // ListUsers streams all users
  rpc ListUsers(stream GetUserRequest) returns (stream UserResponse) {
    option (cli.command) = {
      command: ["user", "list"],
      description: "List all users"
    };
  }
}
