syntax = "proto3";

package example;

import "google/protobuf/timestamp.proto";
import "proto/cli/v1/cli.proto";

option go_package = "github.com/drewfead/proto-cli/simple";

// DatabaseConfig is a nested configuration message
message DatabaseConfig {
  string url = 1 [(cli.v1.flag) = {
    name: "url"
    usage: "Database connection URL"
  }];
  int32 max_connections = 2 [(cli.v1.flag) = {
    name: "max-connections"
    usage: "Maximum database connections"
  }];
  int32 timeout_seconds = 3 [(cli.v1.flag) = {
    name: "timeout"
    usage: "Connection timeout in seconds"
  }];
}

// LogLevel enum for configuration
enum LogLevel {
  LOG_LEVEL_UNSPECIFIED = 0;
  DEBUG = 1 [(cli.v1.enum_value) = {name: "debug"}];
  INFO = 2 [(cli.v1.enum_value) = {name: "info"}];
  WARN = 3 [(cli.v1.enum_value) = {name: "warn"}];
  ERROR = 4 [(cli.v1.enum_value) = {name: "error"}];
}

// PostgresBackend configuration
message PostgresBackend {
  string host = 1;
  int32 port = 2;
  string database = 3;
}

// MySQLBackend configuration
message MySQLBackend {
  string host = 1;
  int32 port = 2;
  string database = 3;
  bool enable_ssl = 4;
}

// UserServiceConfig defines configuration for UserService
message UserServiceConfig {
  string database_url = 1 [(cli.v1.flag) = {
    name: "db-url"
    usage: "PostgreSQL connection URL"
    required: true
  }];
  int64 max_connections = 2 [(cli.v1.flag) = {
    name: "max-conns"
    usage: "Maximum database connections"
  }];

  // Nested message field
  DatabaseConfig database = 3 [(cli.v1.flag) = {
    name: "database"
    usage: "Database configuration"
  }];

  // Enum field
  LogLevel log_level = 4 [(cli.v1.flag) = {
    name: "log-level"
    usage: "Logging level"
  }];

  // Repeated field
  repeated string allowed_origins = 5 [(cli.v1.flag) = {
    name: "allowed-origins"
    usage: "CORS allowed origins"
  }];

  // Map field
  map<string, string> feature_flags = 6;

  // Oneof (union type)
  oneof backend {
    PostgresBackend postgres = 7;
    MySQLBackend mysql = 8;
  }
}

// Address is a nested message type for demonstrating recursive deserializers
message Address {
  string street = 1;
  string city = 2;
  string state = 3;
  string zip_code = 4;
  string country = 5;
}

// User message definition
message User {
  int64 id = 1;
  string name = 2;
  string email = 3;
  google.protobuf.Timestamp created_at = 4; // External type to test import qualification
  Address address = 5; // Nested address field
}

// Request to get a user by ID
message GetUserRequest {
  int64 id = 1 [(cli.v1.flag) = {
    name: "id"
    shorthand: "i"
    usage: "User ID to retrieve"
    required: true
  }];

  // Field with partial annotation - demonstrates name defaults to kebab-case
  bool include_details = 2 [(cli.v1.flag) = {
    shorthand: "d"
    usage: "Include detailed user information"
  }];

  // Optional fields demonstrate explicit presence tracking in proto3
  optional string fields_filter = 3 [(cli.v1.flag) = {
    name: "fields"
    shorthand: "f"
    usage: "Comma-separated list of fields to return (e.g., 'name,email')"
  }];
  optional int32 timeout_ms = 4 [(cli.v1.flag) = {
    name: "timeout"
    shorthand: "t"
    usage: "Request timeout in milliseconds"
  }];
}

// Request to create a new user
message CreateUserRequest {
  string name = 1 [(cli.v1.flag) = {
    name: "name"
    shorthand: "n"
    usage: "User's full name"
    required: true
  }];
  string email = 2 [(cli.v1.flag) = {
    name: "email"
    shorthand: "e"
    usage: "User's email address"
    required: true
  }];
  Address address = 3; // Nested address - demonstrates recursive deserializers
  google.protobuf.Timestamp registration_date = 4; // External type to test import qualification

  // Field without annotation - demonstrates kebab-case default
  string phone_number = 5;

  // Optional fields demonstrate explicit presence tracking
  optional string nickname = 6 [(cli.v1.flag) = {
    name: "nickname"
    usage: "Optional nickname for the user"
  }];
  optional int32 age = 7 [(cli.v1.flag) = {
    name: "age"
    usage: "User's age in years"
  }];
  optional bool verified = 8 [(cli.v1.flag) = {
    name: "verified"
    usage: "Whether the user email is verified"
  }];
  optional LogLevel log_level = 9 [(cli.v1.flag) = {
    name: "log-level"
    usage: "Optional logging level preference for the user"
  }];
}

// Response containing a user
message UserResponse {
  User user = 1;
  string message = 2;
}

// UserService defines gRPC service methods
service UserService {
  option (cli.v1.service) = {
    name: "user-service"
    description: "User management commands"
    long_description:
      "Comprehensive user management service for CRUD operations.\n\n"
      "This service provides complete user lifecycle management including:\n"
      "- Creating new user accounts\n"
      "- Retrieving user information\n"
      "- Updating user profiles\n"
      "- Managing user authentication and preferences\n\n"
      "All commands require appropriate authentication and authorization."
  };

  option (cli.v1.service_config) = {config_message: "UserServiceConfig"};

  // GetUser retrieves a user by ID
  rpc GetUser(GetUserRequest) returns (UserResponse) {
    option (cli.v1.command) = {
      name: "get"
      description: "Retrieve a user by ID"
      long_description:
        "Fetch detailed information about a user from the database.\n\n"
        "This command queries the user service to retrieve a user record by their unique ID. "
        "You can optionally include additional details like profile information and preferences. "
        "Use --fields to specify which fields to return in the response.\n\n"
        "Examples:\n"
        "  Get basic user info:       usercli user-service get --id 123\n"
        "  Get with details:          usercli user-service get --id 123 --include-details\n"
        "  Get specific fields:       usercli user-service get --id 123 --fields name,email"
      usage_text: "get --id <user-id> [--include-details] [--fields <field-list>]"
      args_usage: ""
    };
  }

  // CreateUser creates a new user
  rpc CreateUser(CreateUserRequest) returns (UserResponse) {
    option (cli.v1.command) = {
      name: "create"
      description: "Create a new user"
    };
  }

  // ListUsers streams all users
  rpc ListUsers(stream GetUserRequest) returns (stream UserResponse) {
    option (cli.v1.command) = {
      name: "list"
      description: "List all users"
    };
  }
}

// Empty request for admin operations
message AdminRequest {}

// Response for admin operations
message AdminResponse {
  string message = 1;
  bool success = 2;
}

// AdminService demonstrates service name override
// Without annotation, this would be "admin-service"
service AdminService {
  option (cli.v1.service) = {
    name: "admin"
    description: "Administrative operations"
  };

  // Health check endpoint
  rpc HealthCheck(AdminRequest) returns (AdminResponse) {
    option (cli.v1.command) = {
      name: "health"
      description: "Check service health"
    };
  }
}
