syntax = "proto3";

package example;

option go_package = "github.com/drewfead/proto-cli/simple";

import "google/protobuf/timestamp.proto";
import "internal/clipb/cli.proto";

// DatabaseConfig is a nested configuration message
message DatabaseConfig {
  string url = 1 [(cli.flag) = {
    name: "url",
    usage: "Database connection URL"
  }];
  int32 max_connections = 2 [(cli.flag) = {
    name: "max-connections",
    usage: "Maximum database connections"
  }];
  int32 timeout_seconds = 3 [(cli.flag) = {
    name: "timeout",
    usage: "Connection timeout in seconds"
  }];
}

// LogLevel enum for configuration
enum LogLevel {
  LOG_LEVEL_UNSPECIFIED = 0;
  DEBUG = 1;
  INFO = 2;
  WARN = 3;
  ERROR = 4;
}

// PostgresBackend configuration
message PostgresBackend {
  string host = 1;
  int32 port = 2;
  string database = 3;
}

// MySQLBackend configuration
message MySQLBackend {
  string host = 1;
  int32 port = 2;
  string database = 3;
  bool enable_ssl = 4;
}

// UserServiceConfig defines configuration for UserService
message UserServiceConfig {
  string database_url = 1 [(cli.flag) = {
    name: "db-url",
    usage: "PostgreSQL connection URL",
    required: true
  }];
  int64 max_connections = 2 [(cli.flag) = {
    name: "max-conns",
    usage: "Maximum database connections"
  }];

  // Nested message field
  DatabaseConfig database = 3 [(cli.flag) = {
    name: "database",
    usage: "Database configuration"
  }];

  // Enum field
  LogLevel log_level = 4 [(cli.flag) = {
    name: "log-level",
    usage: "Logging level"
  }];

  // Repeated field
  repeated string allowed_origins = 5 [(cli.flag) = {
    name: "allowed-origins",
    usage: "CORS allowed origins"
  }];

  // Map field
  map<string, string> feature_flags = 6;

  // Oneof (union type)
  oneof backend {
    PostgresBackend postgres = 7;
    MySQLBackend mysql = 8;
  }
}

// Address is a nested message type for demonstrating recursive deserializers
message Address {
  string street = 1;
  string city = 2;
  string state = 3;
  string zip_code = 4;
  string country = 5;
}

// User message definition
message User {
  int64 id = 1;
  string name = 2;
  string email = 3;
  google.protobuf.Timestamp created_at = 4;  // External type to test import qualification
  Address address = 5;  // Nested address field
}

// Request to get a user by ID
message GetUserRequest {
  int64 id = 1 [(cli.flag) = {
    name: "id",
    shorthand: "i",
    usage: "User ID to retrieve",
    required: true
  }];

  // Field with partial annotation - demonstrates name defaults to kebab-case
  bool include_details = 2 [(cli.flag) = {
    shorthand: "d",
    usage: "Include detailed user information"
  }];

  // Optional fields demonstrate explicit presence tracking in proto3
  optional string fields_filter = 3 [(cli.flag) = {
    name: "fields",
    shorthand: "f",
    usage: "Comma-separated list of fields to return (e.g., 'name,email')"
  }];
  optional int32 timeout_ms = 4 [(cli.flag) = {
    name: "timeout",
    shorthand: "t",
    usage: "Request timeout in milliseconds"
  }];
}

// Request to create a new user
message CreateUserRequest {
  string name = 1 [(cli.flag) = {
    name: "name",
    shorthand: "n",
    usage: "User's full name",
    required: true
  }];
  string email = 2 [(cli.flag) = {
    name: "email",
    shorthand: "e",
    usage: "User's email address",
    required: true
  }];
  Address address = 3;  // Nested address - demonstrates recursive deserializers
  google.protobuf.Timestamp registration_date = 4;  // External type to test import qualification

  // Field without annotation - demonstrates kebab-case default
  string phone_number = 5;

  // Optional fields demonstrate explicit presence tracking
  optional string nickname = 6 [(cli.flag) = {
    name: "nickname",
    usage: "Optional nickname for the user"
  }];
  optional int32 age = 7 [(cli.flag) = {
    name: "age",
    usage: "User's age in years"
  }];
  optional bool verified = 8 [(cli.flag) = {
    name: "verified",
    usage: "Whether the user email is verified"
  }];
}

// Response containing a user
message UserResponse {
  User user = 1;
  string message = 2;
}

// UserService defines gRPC service methods
service UserService {
  option (cli.service_config) = {
    config_message: "UserServiceConfig"
  };

  // GetUser retrieves a user by ID
  rpc GetUser(GetUserRequest) returns (UserResponse) {
    option (cli.command) = {
      name: "get",
      description: "Retrieve a user by ID"
    };
  }

  // CreateUser creates a new user
  rpc CreateUser(CreateUserRequest) returns (UserResponse) {
    option (cli.command) = {
      name: "create",
      description: "Create a new user"
    };
  }

  // ListUsers streams all users
  rpc ListUsers(stream GetUserRequest) returns (stream UserResponse) {
    option (cli.command) = {
      name: "list",
      description: "List all users"
    };
  }
}

// Empty request for admin operations
message AdminRequest {}

// Response for admin operations
message AdminResponse {
  string message = 1;
  bool success = 2;
}

// AdminService demonstrates service name override
// Without annotation, this would be "admin-service"
service AdminService {
  option (cli.service) = {
    name: "admin",
    description: "Administrative operations"
  };

  // Health check endpoint
  rpc HealthCheck(AdminRequest) returns (AdminResponse) {
    option (cli.command) = {
      name: "health",
      description: "Check service health"
    };
  }
}
